<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - LibraryAI</title>
    <link rel="stylesheet" href="../../shared/styles/landing.css">
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <!-- SECURITY: Hide everything until auth is verified -->
    <style>
        body { visibility: hidden; opacity: 0; }
        body.authenticated { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }
    </style>
    <!-- SECURITY: Immediate auth check before page renders -->
    <script>
        (function() {
            // CRITICAL: Clear student session when on admin pages
            localStorage.removeItem('student');
            
            const admin = JSON.parse(localStorage.getItem('admin') || '{}');
            // Must have access_token AND role must be 'admin'
            if (!admin.access_token || admin.role !== 'admin') {
                localStorage.removeItem('admin'); // Clear invalid session
                window.location.replace('login.html');
            }
        })();
    </script>
</head>
<body>
    <!-- SECURITY: Redirect if JavaScript is disabled -->
    <noscript>
        <meta http-equiv="refresh" content="0;url=login.html">
        <style>body { visibility: visible !important; }</style>
        <div style="padding: 50px; text-align: center; font-family: sans-serif;">
            <h1>JavaScript Required</h1>
            <p>Please enable JavaScript to access the admin dashboard.</p>
            <a href="login.html">Go to Login</a>
        </div>
    </noscript>
    <!-- Background -->
    <div class="background-slider">
        <div class="slide active" style="background-image: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?q=80&w=2070')"></div>
        <div class="overlay"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg width="36" height="36" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="6" y="10" width="28" height="20" rx="2" stroke="#EC4899" stroke-width="2"/>
                    <path d="M6 16H34" stroke="#EC4899" stroke-width="2"/>
                    <circle cx="30" cy="12" r="6" fill="#EC4899"/>
                </svg>
                <span>Admin Panel</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-page="overview">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <rect x="3" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <rect x="11" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <rect x="3" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <rect x="11" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                <span>Overview</span>
            </a>

            <a href="#" class="nav-item" data-page="add-book">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>Add Book</span>
            </a>

            <a href="#" class="nav-item" data-page="all-books">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M4 6H16M4 10H16M4 14H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>All Books</span>
            </a>

            <a href="#" class="nav-item" data-page="borrow-records">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <circle cx="7" cy="7" r="4" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M13 13L17 17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>Borrow Records</span>
            </a>

            <a href="#" class="nav-item" data-page="verify-returns">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M7 10L9 12L13 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                <span>Verify Returns</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="../../index.html" class="logout-btn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M7 17H4C3.44772 17 3 16.5523 3 16V4C3 3.44772 3.44772 3 4 3H7M13 13L17 10M17 10L13 7M17 10H7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <header class="dashboard-header">
            <div>
                <h1 id="pageTitle">Dashboard Overview</h1>
                <p id="pageSubtitle">Manage your library system</p>
            </div>
            <div class="header-actions">
                <div class="admin-profile">
                    <div class="admin-avatar">A</div>
                    <span>Admin</span>
                </div>
            </div>
        </header>

        <!-- Overview Page -->
        <div id="overview-page" class="page-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(99, 102, 241, 0.15);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="#6366F1" stroke-width="2"/>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="#6366F1" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <p class="stat-label">Total Books</p>
                        <h3 class="stat-value" id="totalBooks">0</h3>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.15);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="8" r="5" stroke="#10B981" stroke-width="2"/>
                            <path d="M3 21c0-4.97 4.03-9 9-9s9 4.03 9 9" stroke="#10B981" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <p class="stat-label">Active Borrows</p>
                        <h3 class="stat-value" id="activeBorrows">0</h3>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(236, 72, 153, 0.15);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="#EC4899" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <p class="stat-label">Pending Fines</p>
                        <h3 class="stat-value" id="pendingFines">â‚¹0</h3>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.15);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" stroke="#F59E0B" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <p class="stat-label">Pending Verifications</p>
                        <h3 class="stat-value" id="pendingVerifications">0</h3>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="analytics-section">
                <h2>Library Analytics</h2>
                
                <div class="analytics-grid">
                    <!-- Category Distribution -->
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h3>ðŸ“š Books by Category</h3>
                            <span class="analytics-badge" id="categoryCount">0 categories</span>
                        </div>
                        <div class="chart-container" id="categoryChart"></div>
                    </div>

                    <!-- Borrow Status -->
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h3>ðŸ“Š Borrow Status Distribution</h3>
                            <span class="analytics-badge" id="borrowTotal">0 total</span>
                        </div>
                        <div class="chart-container" id="borrowStatusChart"></div>
                    </div>

                    <!-- Top Borrowed Books -->
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h3>ðŸ”¥ Most Borrowed Books</h3>
                            <span class="analytics-badge" id="topBooksCount">Top 5</span>
                        </div>
                        <div class="top-items-list" id="topBooksList"></div>
                    </div>

                    <!-- Fine Analytics -->
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h3>ðŸ’° Fine Collection Insights</h3>
                            <span class="analytics-badge" id="fineInsights">â‚¹0 collected</span>
                        </div>
                        <div class="fine-stats-grid" id="fineStatsGrid"></div>
                    </div>

                    <!-- Availability Status -->
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h3>ðŸ“– Book Availability</h3>
                            <span class="analytics-badge" id="availabilityRate">0%</span>
                        </div>
                        <div class="availability-chart" id="availabilityChart"></div>
                    </div>

                    <!-- Recent Trends -->
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h3>ðŸ“ˆ Borrowing Trends</h3>
                            <span class="analytics-badge" id="trendIndicator">This month</span>
                        </div>
                        <div class="trend-container" id="trendContainer"></div>
                    </div>
                </div>
            </div>

            <div class="recent-activity">
                <h2>Quick Actions</h2>
                <div class="quick-actions-grid">
                    <button class="action-btn" onclick="navigateTo('add-book')">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span>Add New Book</span>
                    </button>
                    <button class="action-btn" onclick="navigateTo('all-books')">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span>View All Books</span>
                    </button>
                    <button class="action-btn" onclick="navigateTo('borrow-records')">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="9" cy="9" r="6" stroke="currentColor" stroke-width="2"/>
                            <path d="M17 17l4 4" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span>Borrow Records</span>
                    </button>
                    <button class="action-btn" onclick="navigateTo('verify-returns')">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2"/>
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span>Verify Returns</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Book Page -->
        <div id="add-book-page" class="page-content">
            <div class="content-card">
                <h2>Add New Book</h2>
                <p class="card-subtitle">Upload a new book to the library system</p>
                
                <form id="addBookForm" class="book-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookTitle">Book Title *</label>
                            <input type="text" id="bookTitle" name="title" required placeholder="Enter book title">
                        </div>

                        <div class="form-group">
                            <label for="bookAuthor">Author *</label>
                            <input type="text" id="bookAuthor" name="author" required placeholder="Enter author name">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="totalCopies">Total Copies *</label>
                            <input type="number" id="totalCopies" name="total_copies" required min="1" placeholder="Number of copies">
                        </div>

                        <div class="form-group">
                            <label for="bookCategories">Categories *</label>
                            <input type="text" id="bookCategories" name="categories" required placeholder="e.g., Fiction, Science, History">
                            <small class="form-hint">Enter comma-separated categories</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Book Visibility *</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="visibility" value="public" checked>
                                <span>Public (Generate AI Content)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="visibility" value="confidential">
                                <span>Confidential (RAG Only)</span>
                            </label>
                        </div>
                        <small class="form-hint">Public: Generates Summary, Q&A, Podcast (~2-3 min). Confidential: Only RAG indexing for chat (~30 sec). Both options enable RAG chat functionality.</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pdfFile">PDF File *</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="pdfFile" name="pdf_file" accept=".pdf" required>
                                <div class="file-input-display">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                        <path d="M6 2C4.89543 2 4 2.89543 4 4V16C4 17.1046 4.89543 18 6 18H14C15.1046 18 16 17.1046 16 16V7L11 2H6Z" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M11 2V7H16" stroke="currentColor" stroke-width="1.5"/>
                                    </svg>
                                    <span class="file-name">Choose PDF file</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="coverImage">Cover Image *</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="coverImage" name="cover_image" accept="image/*" required>
                                <div class="file-input-display">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                        <rect x="3" y="3" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M3 13l4-4 3 3 4-6 3 3" stroke="currentColor" stroke-width="1.5"/>
                                    </svg>
                                    <span class="file-name">Choose image file</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="resetForm()">Reset</button>
                        <button type="submit" class="btn-primary" id="submitBookBtn">
                            <span>Add Book</span>
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M7 4L13 10L7 16" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                    </div>

                    <div class="message-box success" id="successMessage" style="display: none;"></div>
                    <div class="message-box error" id="errorMessage" style="display: none;"></div>
                </form>
            </div>
        </div>

        <!-- All Books Page -->
        <div id="all-books-page" class="page-content">
            <div class="content-card">
                <div class="card-header">
                    <div>
                        <h2>All Books</h2>
                        <p class="card-subtitle">Manage and view all books in the library</p>
                    </div>
                    <button class="btn-primary" onclick="loadAllBooks()">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M4 10a6 6 0 1 1 12 0 6 6 0 0 1-12 0z" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        Refresh
                    </button>
                </div>
                <div id="allBooksContainer"></div>
            </div>
        </div>

        <!-- Borrow Records Page -->
        <div id="borrow-records-page" class="page-content">
            <div class="content-card">
                <div class="card-header">
                    <div>
                        <h2>Borrow Records</h2>
                        <p class="card-subtitle">View all student borrow records with details</p>
                    </div>
                    <button class="btn-primary" onclick="loadBorrowRecords()">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M4 10a6 6 0 1 1 12 0 6 6 0 0 1-12 0z" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        Refresh
                    </button>
                </div>
                <div id="borrowRecordsContainer"></div>
            </div>
        </div>

        <!-- Verify Returns Page -->
        <div id="verify-returns-page" class="page-content">
            <div class="content-card">
                <div class="card-header">
                    <div>
                        <h2>Verify Returns</h2>
                        <p class="card-subtitle">Verify fine payments and complete book returns</p>
                    </div>
                    <button class="btn-primary" onclick="loadPendingVerifications()">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M4 10a6 6 0 1 1 12 0 6 6 0 0 1-12 0z" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        Refresh
                    </button>
                </div>
                <div id="verifyReturnsContainer"></div>
            </div>
        </div>
    </div>

    <script src="../scripts/dashboard.js"></script>
</body>
</html>
